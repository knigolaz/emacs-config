;;ПУТЬ К ПЛАГИНАМ
(add-to-list 'load-path "~/.emacs.d/lisp")



;;ОТОБРАЖЕНИЕ ВРЕМЕНИ
(setq display-time-day-and-date t ; display day and date
      display-time-24hr-format t ; use 24hr format
      display-time-interval 10 ; redisplay every ten seconds
      display-time-default-load-average nil) ; don't display the system load average
(display-time)
(display-battery-mode 1)



;;РЕЖИМ
;;(text-mode)


;; ПЛАВНОЕ ПРОКРУЧИВАНИЕ
(setq scroll-step               1) 
(setq scroll-margin            10) 
(setq scroll-conservatively 10000)


;;ПОДСВЕТКА ТЕКУЩЕЙ СТРОКИ
(global-hl-line-mode 1)
(set-face-background hl-line-face "gray20")


;; МОИ МОДУЛИ
(require 'my-note-mode)
(require 'my-diary-mode)
(require 'my-conspect-mode)



;; ЦВЕТА ПОДСВЕТКИ
;;(set-face-foreground 'font-lock-string-face nil)
;;(set-face-foreground 'font-lock-comment-face "gray30") 
;;(set-face-foreground 'font-lock-type-face "yellow")
;;(set-face-foreground 'font-lock-constant-face "blue")
;;(set-face-foreground 'font-lock-builtin-face "pink")
;;(set-face-foreground 'font-lock-function-name-face "lightgreen")
;;(set-face-foreground 'font-lock-keyword-face "lightblue")
;;(set-face-foreground 'font-lock-variable-name-face "lightblue")



;; РЕПОЗИТОРИИ ДОПОЛНИТЕЛЬНЫХ ПАКЕТОВ
(package-initialize)
(setq package-archives 
	'(("gnu" . "http://elpa.gnu.org/packages/")
      ("marmalade" . "http://marmalade-repo.org/packages/")
      ("melpa" . "http://melpa.milkbox.net/packages/")))



;; ДОП. ПАНЕЛЬ
(setq sr-speedbar-default-width 35)
(setq sr-speedbar-max-width 35)

(require 'sr-speedbar) ; Если инициализировать в начале, то сбрасываются настроки ширины на по умолчанию

(setq sr-speedbar-show-unknown-files t)
(setq sr-speedbar-right-side nil)
(make-face 'speedbar_1)
(set-face-font 'speedbar_1 "Cousine-10")
(setq speedbar-mode-hook '(lambda () (buffer-face-set 'speedbar_1)))




;; AUTOCOMPLETE
(require 'auto-complete-config)
(add-to-list 'ac-dictionary-directories "~/.emacs.d/dict")
(ac-config-default)



;; ЦВЕТ ФОНА И ТЕКСТА И ВЫДЕЛЕНИЯ
(set-background-color "gray10")
(set-foreground-color "grey70")
(set-face-background 'region "gray40")
	


;; МЕНЮ
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)



;; КЛАВИАТУРНЫЕ СОЧЕТАНИЯ
;; Код обеспечивает получение комбинациям клавиш максимального
;; приоритета для исключения ситуации с перехватом комбинаций
;; вновь установленными плагинами.

(defvar cfg-mode-map (make-sparse-keymap))
(define-minor-mode cfg-mode
  "cfg-mode"
  :lighter " cfg"
  cfg-mode-map)

(defadvice load (after cfg-keybindings-priority)
  (if (not (eq (car (car minor-mode-map-alist)) 'cfg-mode))
      (let ((mykeys (assq 'cfg-mode minor-mode-map-alist)))
        (assq-delete-all 'cfg-mode minor-mode-map-alist)
        (add-to-list 'minor-mode-map-alist mykeys))))
(ad-activate 'load)

(defun turn-on-cfg-mode ()
  (interactive)
  (cfg-mode t))

(defun turn-off-cfg-mode ()
  (interactive)
  (cfg-mode -1))

(define-globalized-minor-mode global-cfg-mode cfg-mode turn-on-cfg-mode)

(defun lcl:get-hotkeys ()
  (list
    (list "C-c" 'kill-ring-save)
    (list "C-v" 'yank)
    (list "C-x C-a" 'kill-region)
    (list "<f5>" 'other-window)
    (list "C-a" 'mark-whole-buffer)
    (list "M-1" 'move-beginning-of-line)
    (list "M-2" 'move-end-of-line)
    (list "C-s" 'save-buffer)
    (list "C-f" 'isearch-forward)
    (list "C-o" 'find-file)
    (list "C-t" 'table-insert)
    (list "<f12>" 'show-my-help)
    (list "C-n" 'switch-to-buffer)
    (list "<f2>" 'bs-show)
    (list "C-<f1>" 'describe-variable)
    (list "<f8>" (lambda ()
		    (interactive)
		    (sr-speedbar-toggle)
		    (speedbar-toggle-show-all-files)))
    (list "<f6>" 'eval-last-sexp)
    (list "C-p" 'toggle-current-window-dedication)
    (list "C-z" 'undo)
    (list "TAB" 'my-insert-tab-char)
    (list "M-q" 'kill-this-buffer )
    (list "<f9>" 'bookmark-bmenu-list)
    (list "C-<f9>" 'bookmark-set)
    (list "M-<f9>" 'bookmark-delete)
    (list "M-f" 'replace-string)
    (list "M-r" 'query-replace)
    (list "<f7>" 'TeX-command-run-all)
    (list "M-s" 'ido-write-file)
  ))

(defun cfg:cfg-hotheys (map)
  (dolist (k (lcl:get-hotkeys))
    (when k
      (let ((key (kbd (car k)))
            (func (car (cdr k))))
        (define-key map key func)
        (global-set-key key func)))))

(defun cfg:cfg ()
  (add-hook 'minibuffer-setup-hook 'turn-off-cfg-mode)
  (cfg:cfg-hotheys cfg-mode-map)
  (global-cfg-mode))
  
(cfg:cfg)


;; ПОДСКАЗКА ПО КЛАВИАТУРНЫМ СОЧЕТАНИЯМ
(defun show-my-help ()
  (interactive)
  (message "    
C-c Копировать; f7 Компилировать Latex; C-v Вставить; C-x C-a Вырезать; f5 Перейти на другой окно;
C-a Выделить всё; M-1 Перейти на начало строки; M-2 Перейти в конец строки; C-s Сохранить;
C-f Поиск вперед; C-o Открыть; C-t Вставить таблицу; f12 Показать мое меню; C-n Перейти в буфер;
f2  Список буферов; C-f1 Справка по переменным; f8 Дополнительное меню; f6  Выполнить lisp команду;
C-p Закрепить окно; C-z Отменить действие; TAB Таб; M-q Закрыть текущий буфер; f9 Меню закладок;
C-f9 Добавить закладку; M-f9 Удалить закладку; M-f Заменить; M-r  Заменить с подтверждением;
M-s Сохранить как
"))



;; COLOR THEME
;; Мои настройки лучше, но оставлю на всякий случай
;;(add-to-list 'load-path "~/emacs.d")
;;(require 'color-theme)
;;(color-theme-initialize)
;;(setq color-theme-is-global t)
;;(color-theme-robin-hood)
;;(color-theme-classic)
;;(color-theme-select)



;; НЕ ПОКАЗЫВАТЬ ЭКРАН ЗАСТАВКИ
(setq inhibit-startup-message t)



;; ВЫВОД НА ПОЛНЫЙ ЭКРАН
(toggle-frame-fullscreen)



;; ШРИФТ
(set-default-font "Cousine-12")



;; ПЕРЕКЛЮЧЕНИЕ МЕЖДУ ОКНАМИ ЧЕРЕЗ SHIFT И СТРЕЛКИ
(windmove-default-keybindings)



;; ОТКЛЮЧЕНИЕ ЗВУКА
(setq bell-volume 0)
(setq sound-alist nil)



;; ФИКСАЦИЯ ОКНА
(defun toggle-current-window-dedication ()
  (interactive)
  (let* ((window
	  (selected-window))
	 (dedicated (window-dedicated-p window)))
    (set-window-dedicated-p window (not dedicated))
    (message "Window %sdedicated to %s"
	     (if dedicated "no longer " "")
	     (buffer-name)))) 



;; YASNIPPET 
(require 'yasnippet)
(setq yas-snippet-dirs '("~/.emacs.d/snippets" ))
(yas-global-mode 1) ;; or M-x yas-reload-all if you've started YASnippet already.




;; АВТОВЫБОР СОДЕРЖИМОГО
(require 'ido)
(ido-mode t)
(setq ido-enable-flex-matching t)
(icomplete-mode                t)
(ido-everywhere                t)
(setq ido-vitrual-buffers      t)
(setq ido-enable-flex-matching t)



;; ПОКАЗЫВАТЬ НОМЕРА СТРОК
(require 'linum+)
(setq linum-format "%d ")
(global-linum-mode 1)
 


 
;; АВТОСОХРАНЕНИЕ И БЕКАПЫ
(setq make-backup-files         nil) ; Don't want any backup files
(setq auto-save-list-file-name  nil) ; Don't want any .saves files
(setq auto-save-default         nil) ; Don't want any auto saving



;;РЕЖИМ ORG MODE
(setq org-log-done t)
(setq org-todo-keywords '((sequence "TODO" "DELEGATED" "|" "DONE" "DELETE")))



;; ПЕРЕНОС ПО СЛОВАМ
(setq word-wrap          t) ;; переносить по словам
(global-visual-line-mode t)



;; ОТОБРАЖАТЬ БУФЕР SCRATCH И MESSAGES
(require 'bs)
(setq bs-configurations
      '(("files" "^\\*scratch\\*" nil nil bs-visits-non-file bs-sort-buffer-interns-are-last)))



;; TAB
(defun my-insert-tab-char()
  "Insert a tab char. (ASCII 9, "\t")"
	(interactive)
	(insert "\t"))



;; ВЫДЕЛЕНИЕ СКОБОК ДЛЯ LISP РЕЖИМА
(show-paren-mode t)   
;;(setq show-paren-style 'expression) ; подсвечивает блоки, но раздражает




;; TEX
(add-to-list 'load-path "~/.emacs.d/auctex-12.1.0")
(load "auctex.el" nil t t)
(load "preview.el" nil t t)
(setq TeX-auto-save t)
(setq TeX-parse-self t)
(setq-default TeX-master nil)
(setq TeX-PDF-mode t)




;; CALENDAR
(setq calendar-week-start-day 1) ;первый день недели - понедельник, а не воскресенье
(setq european-calendar-style 't) ;показывать даты в привычной мне русско-европейской форме, дд/мм/гг:




;; РАБОТА КОМБИНАЦИЙ КЛАВИШ УПРАВЛЕНИЯ В РУССКОЙ РАСКЛАДКИ
(defun cfg:reverse-input-method (input-method)
  "Build the reverse mapping of single letters from INPUT-METHOD."
  (interactive
   (list (read-input-method-name "Use input method (default current): ")))
  (if (and input-method (symbolp input-method))
      (setq input-method (symbol-name input-method)))
  (let ((current current-input-method)
        (modifiers '(nil (control) (meta) (control meta))))
    (when input-method
      (activate-input-method input-method))
    (when (and current-input-method quail-keyboard-layout)
      (dolist (map (cdr (quail-map)))
        (let* ((to (car map))
               (from (quail-get-translation
                      (cadr map) (char-to-string to) 1)))
          (when (and (characterp from) (characterp to))
            (dolist (mod modifiers)
              (define-key local-function-key-map
                (vector (append mod (list from)))
                (vector (append mod (list to)))))))))
    (when input-method
      (activate-input-method current))))

(cfg:reverse-input-method 'russian-computer)


;;ОТСТУПЫ 
(setq-default tab-width  4)

;;ОТКРЫВАТЬ РАНЕЕ ОТКРЫТЫЕ ФАЙЛЫ
(desktop-save-mode 1)

;;ПЕЧАТЬ
;;(setq printer-name "\\PC-HOME-1\\HP LaserJet Professional P1102")
;;(setq ps-printer-name "\\PC_HOME-1\\HP LaserJet Professional P1102")
